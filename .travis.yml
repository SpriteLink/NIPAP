language: python
python:
  - 2.7

virtualenv:
    system_site_packages: true

install:
    # we use our debian repo to get ip4r
    - echo "deb http://spritelink.github.io/NIPAP/repos/apt stable main extra" | sudo tee /etc/apt/sources.list.d/nipap.list
    - sudo apt-get update -qq
    # install dependencies for building packages and build debian packages
    - sudo apt-get install -qq -y --force-yes devscripts python-docutils
    - make builddeb
    # install dependencies for installing & running nipap
    - sudo apt-get install -qq -y --force-yes python-pysqlite2 python-psycopg2 python-ipy python-ldap python-docutils postgresql postgresql-9.1-ip4r python-tornado python-flask python-flask-xml-rpc python-flask-compress
    # install the newly built nipap packages
    - sudo dpkg -i nipap*.deb python-pynipap*.deb
    # move configuration files into place
    - sudo cp nipap/nipap.conf.dist /etc/nipap/nipap.conf
    - sudo cp nipap/local_auth.db /etc/nipap/
    # create local user for unittests
    - sudo nipap/nipap-passwd add -u unittest -f /etc/nipap/local_auth.db -p gottatest -n "User for running unit tests"
    - sudo nipap/nipap-passwd add -u readonly -f /etc/nipap/local_auth.db -p gottatest --readonly -n "Read-only user for running unit tests"
    # populate answers to nipapd package install questions and reconfigure
    - echo "set nipapd/autoconf true" | sudo debconf-communicate
    - echo "set nipapd/startup true" | sudo debconf-communicate
    - sudo dpkg-reconfigure nipapd
    - cp nipap-cli/nipaprc ~/.nipaprc
    - sed -i -e 's/username = guest/username = unittest/' -e 's/password = guest/password = gottatest/' ~/.nipaprc

script:
    - cd tests
    - nosetests xmlrpc.py
    - nosetests nipaptest.py
    - nosetests test_cli.py
    - nosetests nipap-ro.py

notifications:
    irc:
        channels:
            - "irc.freenode.org#NIPAP"
        skip_join: true
